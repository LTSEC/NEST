{% extends "base.html" %}

{% block title %}Announcements{% endblock %}

{% block content %}
<div class="announcements">
    {% if current_user.privilege == 'admin' %}
    <!-- Floating button for admins -->
    <button class="floating-button" id="toggle-form-button" onclick="toggleAnnouncementForm()">+</button>
    {% endif %}
    
    <h1 class="announcement-header">Announcements</h1>

    <!-- Admin-only form to create announcements (Hidden by default) -->
    {% if current_user.privilege == 'admin' %}
    <div id="create-announcement" class="create-announcement" style="display: none;">
        <h2 class="form-title">Create a New Announcement</h2>
        <form id="create-announcement-form" action="{{ url_for('announcements') }}" class="form-container" method="POST">
            <label class="form-label" for="title">Title:</label>
            <input class="form-input" id="title" name="title" placeholder="Enter the announcement title..." required type="text" />

            <label class="form-label" for="description">Description:</label>
            <textarea class="textarea-input" id="description" name="description" placeholder="Enter the announcement content..." required rows="3"></textarea>

            <button class="form-submit-button" type="submit">Post Announcement</button>
        </form>
    </div>
    {% endif %}

    <!-- List of Announcements -->
    {% if announcements %}
        <div class="announcement-list">
            {% for announcement in announcements %}
                <div class="announcement-card" id="announcement-{{ announcement.announcement_id }}">
                    <h2 class="announcement-title">{{ announcement.title }}</h2>
                    <p class="description">{{ announcement.content | trim }}</p>
                    <p class="announcement-meta">
                        Posted by: {{ announcement.author }} | {{ announcement.created_at.strftime('%B %d, %Y') }} | Visible {{ announcement.is_visible }}
                    </p>

                    {% if current_user.privilege == 'admin' %}
                    <div class="admin-actions">
                        <!-- Edit -->
                        <button class="admin-edit-button" onclick="editAnnouncement({{ announcement.announcement_id }})">Edit</button>
                        <!-- Hide/Unhide -->
                        <button class="admin-toggle-button" onclick="toggleAnnouncement({{ announcement.announcement_id }})">
                            {{ 'Hide' if announcement.is_visible else 'Unhide' }}
                        </button>
                        <!-- Delete -->
                        <button class="admin-delete-button" onclick="deleteAnnouncement({{ announcement.announcement_id }})">Delete</button>
                    </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-announcements-message">No announcements available at the moment.</p>
    {% endif %}
</div>

<script>
    // Toggle Create Announcement Form
    function toggleAnnouncementForm() {
        const formContainer = document.getElementById("create-announcement");
        const button = document.getElementById("toggle-form-button");

        if (formContainer.style.display === "none" || formContainer.style.display === "") {
            formContainer.style.display = "block";
            button.textContent = "×"; // Change "+" to "×"
        } else {
            formContainer.style.display = "none";
            button.textContent = "+"; // Change back to "+"
        }
    }

    // Function to handle AJAX form submission for creating an announcement
    document.getElementById('create-announcement-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch("{{ url_for('announcements') }}", {
            method: "POST",
            body: formData
        }).then(response => response.text())
          .then(() => location.reload());  // Refresh list without full page reload
    });

    // Function to edit an announcement
    function editAnnouncement(id) {
        const newTitle = prompt("Enter the new title:");
        const newContent = prompt("Enter the new content:");

        if (newTitle && newContent) {
            fetch(`/announcements/edit/${id}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title: newTitle, content: newContent })
            }).then(response => response.text())
              .then(() => location.reload());
        }
    }

    // Function to toggle visibility of an announcement
    function toggleAnnouncement(id) {
        fetch(`/announcements/toggle/${id}`, { method: "POST" })
            .then(response => response.text())
            .then(() => location.reload());
    }

    // Function to delete an announcement
    function deleteAnnouncement(id) {
        if (confirm("Are you sure you want to delete this announcement?")) {
            fetch(`/announcements/delete/${id}`, { method: "POST" })
                .then(response => response.text())
                .then(() => {
                    document.getElementById(`announcement-${id}`).remove();
                });
        }
    }
</script>
{% endblock %}
