{% extends "base.html" %}

{% block title %}Team Manager{% endblock %}

{% block content %}
<div class="manage-team-list">

    <button class="floating-button" id="toggle-form-button" onclick="toggleTeamForm()">+</button>

    <div id="create-team" class="create-announcement" style="display: none;">
        <h2 class="form-title">Create a New Team</h2>
        <form id="create-team-form" action="{{ url_for('manage_team') }}" class="form-container" method="POST">
            <label class="form-label" for="team_name">Team name:</label>
            <input class="form-input" id="team_name" name="team_name" placeholder="Enter team name..." required type="text" />

            <label class="form-label" for="team_password">Team password:</label>
            <input class="form-input" id="team_password" name="team_password" placeholder="Enter team password..." required type="text" />
            
            <label class="form-label" for="team_id">Team ID:</label>
            <input class="form-input" id="team_id" name="team_id" placeholder="Enter team ID..." required type="number" />

            <label class="form-label" for="team_color">Team color:</label>
            <input class="form-input" id="team_color" name="team_color" placeholder="Enter team color..." required type="color" />

            <button class="form-submit-button" type="submit">Add Team</button>
        </form>
    </div>

    {% for team in teams %}
    <div class="manage-team-card" id="team-card-{{ team.team_id }}">
        <div class="manage-team-info">
            <span class="team-circle"style="background-color: {{ team.team_color }};"></span>
            <div class="manage-team-text">
                <span class="manage-team-name">{{ team.team_name }}</span>
                <span class="manage-team-id">(ID: {{ team.team_id }})</span>
            </div>
        </div>
        <div class="manage-team-actions">
            <button class="edit-button" data-team-id="{{ team.team_id }}" data-team-name="{{ team.team_name }}">Edit</button>
            <button class="delete-button" data-team-id="{{ team.team_id }}">Delete</button>
            <button class="showpass-button" data-team-id="{{ team.team_id }}">Password</button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal for Editing Team -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Edit Team</h2>
        <form id="editForm">
            <input type="hidden" id="teamId" name="team_id">
            <label for="teamName">New Team Name:</label>
            <input type="text" id="teamName" name="team_name" placeholder="Leave blank to keep current name">
            <label for="teamPassword">New Password:</label>
            <input type="password" id="teamPassword" name="team_password" placeholder="Leave blank to keep current password">
            <button type="submit" class="save-button">Save Changes</button>
        </form>
    </div>
</div>

<script>
// Modal Handling
const modal = document.getElementById('editModal');
const closeButton = document.querySelector('.close-button');
const editButtons = document.querySelectorAll('.edit-button');
const deleteButtons = document.querySelectorAll('.delete-button');
const showpassButtons = document.querySelectorAll('.showpass-button');
const editForm = document.getElementById('editForm');

// Open the modal with pre-filled team details
editButtons.forEach(button => {
    button.addEventListener('click', () => {
        const teamId = button.getAttribute('data-team-id');
        const teamName = button.getAttribute('data-team-name');
        
        document.getElementById('teamId').value = teamId;
        document.getElementById('teamName').value = teamName;
        document.getElementById('teamPassword').value = '';
        
        modal.style.display = 'block';
    });
});

// Close the modal
closeButton.addEventListener('click', () => {
    modal.style.display = 'none';
});

// Submit the form
editForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const teamId = document.getElementById('teamId').value;
    const teamName = document.getElementById('teamName').value || null;
    const teamPassword = document.getElementById('teamPassword').value || null;

    try {
        const response = await fetch(`/team-manager/edit/${teamId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                team_name: teamName,
                team_password: teamPassword
            })
        });

        if (response.ok) {
            location.reload(); // Reload the page on success
        } else {
            console.error('Failed to update team');
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

// Handle delete team
deleteButtons.forEach(button => {
    button.addEventListener('click', async () => {
        const teamId = button.getAttribute('data-team-id');
        const confirmed = confirm("Are you sure you want to delete this team?");
        
        if (confirmed) {
            try {
                const response = await fetch(`/team-manager/delete/${teamId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // Remove the deleted team from the DOM
                    const teamCard = document.getElementById(`team-card-${teamId}`);
                    if (teamCard) {
                        teamCard.remove();
                    }
                } else {
                    console.error('Failed to delete team');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
    });
});

showpassButtons.forEach(button => {
    button.addEventListener('click', async () => {
        const teamId = button.getAttribute('data-team-id');

        try {
            const response = await fetch(`/team-manager/get-pass/${teamId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    team_id: teamId
                })
            });

            if (response.ok) {
                const data = await response.json();
                const password = data.password;

                // Show the password to the user (e.g., via an alert or a modal)
                alert(`Password for Team ID ${teamId}: ${password}`);
            } else {
                console.error('Failed to fetch the password.');
                alert('Could not retrieve the password. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while fetching the password.');
        }
    });
});


// Close modal when clicking outside of it
window.onclick = (event) => {
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};


function toggleTeamForm() {
        const formContainer = document.getElementById("create-team");
        const button = document.getElementById("toggle-form-button");

        if (formContainer.style.display === "none" || formContainer.style.display === "") {
            formContainer.style.display = "block";
            button.textContent = "×"; // Change "+" to "×"
        } else {
            formContainer.style.display = "none";
            button.textContent = "+"; // Change back to "+"
        }
    }

// Function to handle AJAX form submission for creating a team
document.getElementById('create-team-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const id = formData.get("team_id")

    fetch(`/team-manager/add/${id}`, {
        method: "POST",
        body: formData
    }).then(response => response.text())
        .then(() => location.reload());  // Refresh list without full page reload
});

</script>
{% endblock %}
